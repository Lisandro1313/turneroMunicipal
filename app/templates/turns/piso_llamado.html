{% extends "base.html" %}

{% block title %}Llamado Piso {{ numero_piso }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-building"></i> Piso {{ numero_piso }} - Llamado de Visitantes</h2>
                    <p class="text-muted mb-0">Turnos en espera para las áreas de este piso</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#chatModal">
                    <i class="bi bi-chat-dots"></i> Chat <span class="badge bg-danger" id="chatBadge" style="display:none;">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Áreas del piso -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Áreas en este piso:</h5>
                    <div class="d-flex flex-wrap gap-2">
                        {% for area in areas_piso %}
                        <span class="badge bg-info fs-6">{{ area.icon }} {{ area.nombre }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Turnos en espera -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Visitantes Esperando</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaEspera">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Nombre</th>
                                    <th>DNI</th>
                                    <th>Área destino</th>
                                    <th>Motivo</th>
                                    <th>Tiempo espera</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="turnosEspera">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="bi bi-hourglass"></i> Cargando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Turnos llamados recientemente -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-telephone-forward"></i> Llamados Recientemente</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Hora llamado</th>
                                    <th>Nombre</th>
                                    <th>Área</th>
                                    <th>Llamado por</th>
                                    <th>Atendido por</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="turnosLlamados">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Sin llamados recientes</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación de llamado -->
<div class="modal fade" id="llamarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-telephone"></i> Llamar Visitante</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Visitante:</strong> <span id="modalNombre"></span></p>
                <p><strong>DNI:</strong> <span id="modalDni"></span></p>
                <p><strong>Área destino:</strong> <span id="modalArea"></span></p>
                <p><strong>Motivo:</strong> <span id="modalMotivo"></span></p>
                <hr>
                <div class="mb-3">
                    <label class="form-label"><strong>Tu nombre (quién llama):</strong></label>
                    <input type="text" class="form-control" id="inputLlamadoPor" placeholder="Ej: Juan Pérez">
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Quién va a atender:</strong></label>
                    <input type="text" class="form-control" id="inputAtendidoPor" placeholder="Ej: Alberto, Lisandro, etc.">
                    <small class="text-muted">Nombre de la persona que atenderá al visitante</small>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Al llamar, recepción será notificada para hacer subir al visitante.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarLlamar">
                    <i class="bi bi-telephone-fill"></i> Llamar ahora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Chat -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-chat-dots"></i> Chat General - Piso {{ numero_piso }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="chatMensajes" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background-color: #f8f9fa;">
                    <p class="text-center text-muted">Cargando mensajes...</p>
                </div>
            </div>
            <div class="modal-footer">
                <div class="input-group">
                    <input type="text" class="form-control" id="inputNombreChat" placeholder="Tu nombre..." style="max-width: 150px;">
                    <input type="text" class="form-control" id="inputMensaje" placeholder="Escribe un mensaje..." maxlength="500">
                    <button class="btn btn-primary" id="btnEnviarMensaje">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para marcar como atendido -->
<div class="modal fade" id="atenderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Marcar como Atendido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Visitante:</strong> <span id="modalNombreAtender"></span></p>
                <p><strong>Área:</strong> <span id="modalAreaAtender"></span></p>
                <div class="alert alert-success">
                    <i class="bi bi-info-circle"></i> El turno será marcado como completado.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarAtender">
                    <i class="bi bi-check-circle-fill"></i> Completar atención
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let turnoIdSeleccionado = null;
const PISO = {{ numero_piso }};

// Cargar turnos en espera
function cargarTurnosEspera() {
    fetch(`/turns/api/turnos?estado=ESPERA&piso=${PISO}`)
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('turnosEspera');
            const turnos = data.data || [];  // Corregido: usar data.data
            if (turnos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-check-circle"></i> No hay visitantes esperando</td></tr>';
                return;
            }
            
            tbody.innerHTML = turnos.map(t => {
                const tiempo = calcularTiempoEspera(t.hora_llegada);
                const colorTiempo = tiempo > 15 ? 'text-danger fw-bold' : tiempo > 10 ? 'text-warning' : '';
                return `
                    <tr>
                        <td>${formatearHora(t.hora_llegada)}</td>
                        <td><strong>${t.nombre}</strong></td>
                        <td>${t.dni || '-'}</td>
                        <td><span class="badge bg-info">${t.area_nombre}</span></td>
                        <td>${t.motivo_texto || '-'}</td>
                        <td class="${colorTiempo}">${tiempo} min</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="abrirModalLlamar(${t.id}, '${t.nombre}', '${t.dni || ''}', '${t.area_nombre}', '${t.motivo_texto || ''}')">
                                <i class="bi bi-telephone"></i> Llamar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        });
}

// Cargar turnos llamados
function cargarTurnosLlamados() {
    fetch(`/turns/api/turnos?piso=${PISO}`)
        .then(r => r.json())
        .then(data => {
            const todosTurnos = data.data || [];  // Corregido: usar data.data
            const llamados = todosTurnos.filter(t => 
                t.estado === 'AUTORIZADO_SUBIR' || t.estado === 'ATENDIDO'
            ).slice(0, 5);
            
            const tbody = document.getElementById('turnosLlamados');
            if (llamados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Sin llamados recientes</td></tr>';
                return;
            }
            
            tbody.innerHTML = llamados.map(t => `
                <tr>
                    <td>${t.hora_autorizado ? formatearHora(t.hora_autorizado) : '-'}</td>
                    <td>${t.nombre}</td>
                    <td>${t.area_nombre}</td>
                    <td><strong>${t.llamado_por || 'Recepción'}</strong></td>
                    <td>${t.atendido_por || '-'}</td>
                    <td>
                        ${t.estado === 'ATENDIDO' 
                            ? '<span class="badge bg-success">Atendido</span>' 
                            : '<span class="badge bg-warning text-dark">Subiendo</span>'}
                    </td>
                    <td>
                        ${t.estado === 'AUTORIZADO_SUBIR' 
                            ? `<button class="btn btn-sm btn-success" onclick="abrirModalAtender(${t.id}, '${t.nombre}', '${t.area_nombre}')">
                                <i class="bi bi-check-circle"></i> Atender
                               </button>`
                            : '<small class="text-muted">Completado</small>'}
                    </td>
                </tr>
            `).join('');
        });
}

function abrirModalLlamar(id, nombre, dni, area, motivo) {
    turnoIdSeleccionado = id;
    document.getElementById('modalNombre').textContent = nombre;
    document.getElementById('modalDni').textContent = dni || 'Sin DNI';
    document.getElementById('modalArea').textContent = area;
    document.getElementById('modalMotivo').textContent = motivo || 'Sin motivo';
    document.getElementById('inputLlamadoPor').value = '{{ current_user.username }}';
    
    const modal = new bootstrap.Modal(document.getElementById('llamarModal'));
    modal.show();
}

document.getElementById('btnConfirmarLlamar').addEventListener('click', function() {
    const llamadoPor = document.getElementById('inputLlamadoPor').value.trim();
    const atendidoPor = document.getElementById('inputAtendidoPor').value.trim();
    
    if (!llamadoPor) {
        alert('Por favor ingresa tu nombre');
        return;
    }
    
    if (!atendidoPor) {
        alert('Por favor ingresa quién va a atender');
        return;
    }
    
    fetch(`/turns/api/turnos/${turnoIdSeleccionado}/autorizar`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            llamado_por: llamadoPor,
            atendido_por: atendidoPor
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('llamarModal')).hide();
            cargarTurnosEspera();
            cargarTurnosLlamados();
            
            // Mostrar notificación
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                <div class="toast show bg-success text-white" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-check-circle"></i> Visitante llamado exitosamente
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    });
});

function abrirModalAtender(id, nombre, area) {
    turnoIdSeleccionado = id;
    document.getElementById('modalNombreAtender').textContent = nombre;
    document.getElementById('modalAreaAtender').textContent = area;
    
    const modal = new bootstrap.Modal(document.getElementById('atenderModal'));
    modal.show();
}

document.getElementById('btnConfirmarAtender').addEventListener('click', function() {
    fetch(`/turns/api/turnos/${turnoIdSeleccionado}/atender`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('atenderModal')).hide();
            cargarTurnosEspera();
            cargarTurnosLlamados();
            
            // Mostrar notificación
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                <div class="toast show bg-success text-white" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-check-circle"></i> Turno marcado como atendido
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    });
});

// Chat
function cargarMensajes() {
    fetch('/turns/api/chat/mensajes?limite=50')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('chatMensajes');
            if (data.mensajes.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No hay mensajes aún</p>';
                return;
            }
            
            container.innerHTML = data.mensajes.map(m => {
                const esMio = m.usuario === '{{ current_user.username }}';
                const origenLabel = m.origen === 'recepcion' ? 'Recepción' : `Piso ${m.origen.replace('piso_', '')}`;
                return `
                    <div class="mb-2 ${esMio ? 'text-end' : ''}">
                        <div class="d-inline-block ${esMio ? 'bg-primary text-white' : 'bg-white'} p-2 rounded shadow-sm" style="max-width: 70%;">
                            <small class="d-block ${esMio ? 'text-white-50' : 'text-muted'}">
                                <strong>${m.usuario}</strong> (${origenLabel}) - ${formatearFechaHora(m.timestamp)}
                            </small>
                            <p class="mb-0">${m.mensaje}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        });
}

document.getElementById('btnEnviarMensaje').addEventListener('click', function() {
    const inputMensaje = document.getElementById('inputMensaje');
    const inputNombre = document.getElementById('inputNombreChat');
    const mensaje = inputMensaje.value.trim();
    const nombre = inputNombre.value.trim() || 'Anónimo';
    
    if (!mensaje) return;
    
    fetch('/turns/api/chat/enviar', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            usuario: nombre,
            mensaje: mensaje,
            origen: `piso_${PISO}`
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            inputMensaje.value = '';
            cargarMensajes();
        }
    });
});

document.getElementById('inputMensaje').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('btnEnviarMensaje').click();
    }
});

// Utilidades
function formatearHora(isoString) {
    const fecha = new Date(isoString);
    return fecha.toLocaleTimeString('es-AR', {hour: '2-digit', minute: '2-digit'});
}

function formatearFechaHora(isoString) {
    const fecha = new Date(isoString);
    return fecha.toLocaleString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function calcularTiempoEspera(horaLlegada) {
    const ahora = new Date();
    const llegada = new Date(horaLlegada);
    return Math.floor((ahora - llegada) / 60000);
}

// Auto-refresh
setInterval(() => {
    cargarTurnosEspera();
    cargarTurnosLlamados();
}, 10000);

setInterval(cargarMensajes, 5000);

// Cargar inicial
cargarTurnosEspera();
cargarTurnosLlamados();
cargarMensajes();

// Event listener para cuando se abre el modal de chat
document.getElementById('chatModal').addEventListener('shown.bs.modal', cargarMensajes);
</script>
{% endblock %}
