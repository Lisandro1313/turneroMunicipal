{% extends "base.html" %}

{% block title %}Estadísticas - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="bi bi-graph-up"></i> Estadísticas y Reportes
            </h1>
            <p class="text-muted">Análisis de entregas y métricas del sistema</p>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row g-3 mb-4" id="overviewStats">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Organizaciones Activas</h6>
                            <h2 class="mb-0" id="totalOrgs">-</h2>
                        </div>
                        <i class="bi bi-building fs-1 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Tasa de Cumplimiento</h6>
                            <h2 class="mb-0" id="completionRate">-</h2>
                        </div>
                        <i class="bi bi-percent fs-1 text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Kilos Entregados</h6>
                            <h2 class="mb-0" id="totalKilos">-</h2>
                        </div>
                        <i class="bi bi-box-seam fs-1 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Este Mes</h6>
                            <h2 class="mb-0" id="monthKilos">-</h2>
                        </div>
                        <i class="bi bi-calendar-check fs-1 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Entregas por Mes</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" height="80"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Por Dirección</h5>
                </div>
                <div class="card-body">
                    <canvas id="direccionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Organizations -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-trophy"></i> Organizaciones por Entregas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="orgStatsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Organización</th>
                                    <th>Dirección</th>
                                    <th class="text-center">Total Entregas</th>
                                    <th class="text-center">Completadas</th>
                                    <th class="text-end">Total Kilos</th>
                                    <th class="text-center">Tasa</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center py-4">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let monthlyChart, direccionChart;

// Load overview stats
async function loadOverview() {
    const response = await fetch('/stats/api/overview');
    const data = await response.json();
    
    if (data.success) {
        document.getElementById('totalOrgs').textContent = data.data.organizations.total;
        document.getElementById('completionRate').textContent = data.data.schedules.completion_rate + '%';
        document.getElementById('totalKilos').textContent = (data.data.kilos.total_delivered || 0).toLocaleString() + ' kg';
        document.getElementById('monthKilos').textContent = (data.data.kilos.month_delivered || 0).toLocaleString() + ' kg';
    }
}

// Load monthly chart
async function loadMonthlyChart() {
    const response = await fetch('/stats/api/by-month?year=2025');
    const data = await response.json();
    
    if (data.success && data.data.length > 0) {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        
        monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.data.map(d => d.month_name),
                datasets: [{
                    label: 'Entregas Completadas',
                    data: data.data.map(d => d.delivered),
                    backgroundColor: 'rgba(25, 135, 84, 0.8)',
                }, {
                    label: 'Pendientes',
                    data: data.data.map(d => d.pending),
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });
    }
}

// Load direccion chart
async function loadDireccionChart() {
    const response = await fetch('/stats/api/by-direccion');
    const data = await response.json();
    
    if (data.success && data.data.length > 0) {
        const ctx = document.getElementById('direccionChart').getContext('2d');
        
        const colors = [
            'rgba(13, 110, 253, 0.8)',
            'rgba(25, 135, 84, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(220, 53, 69, 0.8)',
            'rgba(13, 202, 240, 0.8)',
            'rgba(111, 66, 193, 0.8)'
        ];
        
        direccionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.data.map(d => d.direccion || 'Sin asignar'),
                datasets: [{
                    data: data.data.map(d => d.total_schedules),
                    backgroundColor: colors,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
            }
        });
    }
}

// Load organization stats
async function loadOrgStats() {
    const response = await fetch('/stats/api/by-organization');
    const data = await response.json();
    
    if (data.success) {
        const tbody = document.querySelector('#orgStatsTable tbody');
        tbody.innerHTML = '';
        
        data.data.sort((a, b) => b.total_kilos - a.total_kilos).forEach(org => {
            const row = `
                <tr>
                    <td><strong>${org.name}</strong></td>
                    <td><span class="badge bg-primary">${org.direccion_municipal || '-'}</span></td>
                    <td class="text-center">${org.total_schedules}</td>
                    <td class="text-center"><span class="badge bg-success">${org.delivered}</span></td>
                    <td class="text-end"><strong>${org.total_kilos.toLocaleString()}</strong> kg</td>
                    <td class="text-center">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: ${org.completion_rate}%"
                                 aria-valuenow="${org.completion_rate}" aria-valuemin="0" aria-valuemax="100">
                                ${org.completion_rate}%
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadOverview();
    loadMonthlyChart();
    loadDireccionChart();
    loadOrgStats();
});
</script>
{% endblock %}
